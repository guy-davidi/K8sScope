<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>eBPF Program Manager - All-in-One UI</title>
  
  <!-- Bootstrap 5 CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    /* Ensure the entire viewport is used and hide body scrolling */
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }
    .navbar {
      height: 60px;
      min-height: 60px;
    }
    .footer {
      height: 50px;
      line-height: 50px;
      min-height: 50px;
    }
    .main-content {
      height: calc(100vh - 110px);
      overflow: hidden;
    }
    .main-content .row {
      height: 100%;
    }
    .card {
      margin-bottom: 0.5rem;
    }
    .card-header {
      font-weight: 600;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }
    .card-body {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
    }
    .custom-table th,
    .custom-table td {
      padding: 0.4rem;
      vertical-align: middle;
      font-size: 0.8rem;
    }
    .custom-table tbody tr:hover {
      background-color: #f1f1f1;
    }
    #o-file-list li {
      padding: 0.3rem 0.75rem;
      border-bottom: 1px solid #e9ecef;
      font-size: 0.8rem;
    }
    #o-file-list li:last-child {
      border-bottom: none;
    }
    .form-label {
      font-size: 0.85rem;
    }
    .form-control,
    .form-select {
      font-size: 0.8rem;
      padding: 0.375rem 0.5rem;
    }
    .btn-lg {
      padding: 0.375rem 0.75rem;
      font-size: 0.9rem;
    }
    .left-column, .right-column {
      height: 100%;
      overflow: hidden;
    }
    /* Initially hide the collector events panel */
    #collector-panel {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Fixed Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">eBPF Program Manager</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#navbarNav" aria-controls="navbarNav"
              aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
  </nav>

  <!-- Toast Container -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055;" aria-live="polite" aria-atomic="true">
    <div id="toastContainer"></div>
  </div>

  <!-- Main Content Area -->
  <div class="main-content container-fluid">
    <div class="row">
      <!-- Left Column: Available .o Files & Loaded Programs -->
      <aside class="col-lg-4 left-column">
        <div class="card shadow-sm">
          <div class="card-header bg-info text-white">
            <span>Available .o Files (ebpf/src)</span>
          </div>
          <div class="card-body p-1" style="max-height: 40%;">
            <ul id="o-file-list" class="list-group list-group-flush"></ul>
          </div>
        </div>
        <div class="card shadow-sm">
          <div class="card-header bg-secondary text-white">
            <span>Loaded eBPF Programs</span>
          </div>
          <div class="card-body p-1" style="max-height: 55%;">
            <table class="table table-sm table-bordered custom-table mb-0">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Type</th>
                  <th>Pinned</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="loaded-table-body"></tbody>
            </table>
          </div>
        </div>
      </aside>

      <!-- Right Column: eBPF Management Form & Real-Time Collector Logs -->
      <section class="col-lg-8 right-column">
        <div class="card shadow-sm mb-2">
          <div class="card-header bg-dark text-white">
            <span>Manage eBPF</span>
          </div>
          <div class="card-body">
            <form id="ebpf-form" novalidate>
              <div class="mb-2">
                <label for="action" class="form-label fw-bold">Action</label>
                <select id="action" class="form-select">
                  <option value="load">Load</option>
                  <option value="attach">Attach</option>
                  <option value="detach">Detach</option>
                  <option value="unload">Unload</option>
                </select>
              </div>
              <div class="mb-2">
                <label for="programInput" class="form-label fw-bold">.o File Name</label>
                <input type="text" class="form-control" id="programInput" placeholder="myprog.o" />
                <small class="text-muted">Pick from the left .o list or type your own</small>
              </div>
              <div class="mb-2">
                <label for="pinPath" class="form-label fw-bold">Pin Path</label>
                <input type="text" class="form-control" id="pinPath" placeholder="/sys/fs/bpf/myprog" />
                <small class="text-muted">Optional: defaults to /sys/fs/bpf/&lt;program&gt;</small>
              </div>
              <div class="mb-2">
                <label for="typeInput" class="form-label fw-bold">Type (tracepoint, xdp, etc.)</label>
                <input type="text" class="form-control" id="typeInput" placeholder="tracepoint" />
                <small class="text-muted">For load: e.g. "tracepoint" or "xdp". For attach: "attach_type"</small>
              </div>
              <div class="mb-2">
                <label for="targetInput" class="form-label fw-bold">Target (tracepoint path or interface)</label>
                <input type="text" class="form-control" id="targetInput" placeholder="/sys/kernel/... or eth0" />
                <small class="text-muted">Default: "sys_enter_execve" or "eth0"</small>
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-success btn-lg">
                  <strong>Execute</strong>
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Toggle Button for Collector Logs -->
        <div class="d-grid mb-2">
          <button id="toggleLogsBtn" class="btn btn-secondary btn-lg">Show Logs</button>
        </div>

        <!-- Real-Time Collector Events Panel -->
        <div id="collector-panel" class="card shadow-sm">
          <div class="card-header bg-success text-white">
            <span>Real-Time Collector Events</span>
          </div>
          <div class="card-body p-1" id="collector-events" style="max-height: 40%; overflow-y: auto;">
            <!-- Collector events will be inserted here -->
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Fixed Footer -->
  <footer class="footer bg-primary text-white text-center">
    <small>&copy; 2025 eBPF Program Manager. All rights reserved.</small>
  </footer>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Custom JS -->
  <script src="{{ url_for('static', filename='main.js') }}"></script>

  <script>
    // Function to show a success toast message
    function showSuccessToast(message) {
      const toastElem = document.createElement('div');
      toastElem.className = 'toast align-items-center text-bg-success border-0';
      toastElem.setAttribute('role', 'alert');
      toastElem.setAttribute('aria-live', 'assertive');
      toastElem.setAttribute('aria-atomic', 'true');
      toastElem.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      const toastContainer = document.getElementById('toastContainer');
      toastContainer.appendChild(toastElem);
      const toast = new bootstrap.Toast(toastElem, { delay: 3000 });
      toast.show();
      toastElem.addEventListener('hidden.bs.toast', () => {
        toastElem.remove();
      });
    }

    // Handle form submission with AJAX (example)
    document.getElementById('ebpf-form').addEventListener('submit', function(e) {
      e.preventDefault();
      // TODO: Add your process logic here and issue an AJAX call to the proper endpoint.
      // For example, call the /api/programs/load endpoint.
      showSuccessToast("Process completed successfully!");
    });

    // Function to fetch collector events periodically
    function fetchCollectorEvents() {
      fetch('/api/collector_events')
        .then(response => response.json())
        .then(data => {
          const eventsDiv = document.getElementById('collector-events');
          eventsDiv.innerHTML = '';
          data.events.slice().reverse().forEach(event => {
            const eventElem = document.createElement('div');
            eventElem.className = 'border-bottom py-1';
            eventElem.style.fontSize = '0.8rem';
            eventElem.textContent = event;
            eventsDiv.appendChild(eventElem);
          });
        })
        .catch(err => console.error("Failed to fetch collector events:", err));
    }

    // Polling is active only when logs are visible
    let pollingInterval;
    function startPolling() {
      pollingInterval = setInterval(fetchCollectorEvents, 2000);
    }
    function stopPolling() {
      clearInterval(pollingInterval);
    }

    // Toggle button to show/hide logs panel
    document.getElementById('toggleLogsBtn').addEventListener('click', function() {
      const panel = document.getElementById('collector-panel');
      if (panel.style.display === 'none' || panel.style.display === '') {
        panel.style.display = 'block';
        this.textContent = 'Hide Logs';
        startPolling();
      } else {
        panel.style.display = 'none';
        this.textContent = 'Show Logs';
        stopPolling();
      }
    });
  </script>
</body>
</html>
